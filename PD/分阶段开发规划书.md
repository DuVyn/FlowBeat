# **FlowBeat 分阶段开发规划书**

基于《FlowBeat 项目结构规划说明书》和《需求规格说明书》，本规划书严格遵循**敏捷开发**与**领域驱动设计 (DDD)** 的理念，将开发过程划分为
7 个阶段。

本版本已包含所有核心业务代码、入口文件、通用组件及测试文件的编写任务，确保开发链路的完整性。

## **第一阶段：基础设施与后端核心架构 (Infrastructure & Backend Core)**

**目标**：构建项目骨架，配置容器化环境，并完成后端基础组件开发。此阶段需确立代码规范与数据库迁移机制。

### **任务 1.1：项目初始化与容器编排**

建立根目录结构，配置 Docker 环境以运行 PostgreSQL、Redis 和 MinIO。

* **编写文件**：
    * FlowBeat/.gitignore：配置 Git 忽略规则（需涵盖 \_\_pycache\_\_, node\_modules, .env, dist 等）。
    * FlowBeat/README.md：项目概述、启动文档与 API 文档链接。
    * FlowBeat/deploy/docker-compose.yml：定义 db, redis, minio 服务及其健康检查。
    * FlowBeat/backend/.env (及 .env.example)：定义数据库连接串、Redis 地址、MinIO 密钥等环境变量。

### **任务 1.2：后端分层架构脚手架**

初始化 FastAPI 应用，配置依赖管理与系统级配置。

* **编写文件**：
    * FlowBeat/backend/pyproject.toml：使用 Poetry/PDM 管理 Python 依赖。
    * FlowBeat/backend/main.py：FastAPI 应用入口，挂载 CORS 中间件与全局异常处理器。
    * FlowBeat/backend/app/core/config.py：利用 pydantic-settings 读取环境变量并进行强类型校验。
    * FlowBeat/backend/app/core/exceptions.py：定义全局异常类（如 AuthError, BusinessError）。

### **任务 1.3：数据库 ORM 与迁移环境**

配置 SQLAlchemy 异步引擎，并初始化 Alembic 以支持异步迁移。

* **编写文件**：
    * FlowBeat/backend/app/models/base.py：定义 DeclarativeBase。
    * FlowBeat/backend/app/repositories/base.py：实现泛型 CRUD 基础仓储类（Generic Repository）。
    * FlowBeat/backend/alembic.ini：Alembic 配置文件。
    * FlowBeat/backend/alembic/env.py：修改 Alembic 默认环境配置，使其支持 asyncio 异步驱动执行迁移。
    * FlowBeat/backend/app/api/deps.py：实现 get\_db 依赖注入函数（AsyncSession 生成器）。

## **第二阶段：身份认证子域 (Identity Subdomain)**

**目标**：实现用户账户体系、JWT 签发验证及 RBAC 权限控制，并引入单元测试框架以确保持续集成的质量。

### **任务 2.1：用户领域建模与仓储**

设计用户表结构，实现用户数据的持久化逻辑。

* **编写文件**：
    * FlowBeat/backend/app/models/user.py：定义 User 实体 (含 role, password\_hash 字段)。
    * FlowBeat/backend/app/models/\_\_init\_\_.py：导出 User 模型供 Alembic 自动发现。
    * FlowBeat/backend/app/schemas/user.py：定义 UserCreate, UserUpdate, UserResponse Pydantic 模型。
    * FlowBeat/backend/app/repositories/user\_repository.py：实现 get\_by\_email 等用户特定查询。

### **任务 2.2：认证服务与安全组件**

实现密码哈希、JWT 令牌生成与解析逻辑。

* **编写文件**：
    * FlowBeat/backend/app/core/security.py：封装 Passlib (bcrypt) 和 PyJWT。
    * FlowBeat/backend/app/schemas/token.py：定义 Token 响应结构。
    * FlowBeat/backend/app/services/auth\_service.py：编排登录验证、注册查重与 Token 签发逻辑。
    * FlowBeat/backend/app/api/deps.py：增加 get\_current\_user 和 get\_current\_active\_superuser 依赖。

### **任务 2.3：认证接口开发**

暴露注册、登录及用户管理接口。

* **编写文件**：
    * FlowBeat/backend/app/api/v1/endpoints/auth.py：Login 接口 (OAuth2PasswordRequestForm)。
    * FlowBeat/backend/app/api/v1/endpoints/users.py：用户注册与个人信息查询接口。
    * FlowBeat/backend/app/api/v1/router.py：聚合所有路由模块。

### **任务 2.4：后端测试基础 (Testing)**

建立测试固件，确保核心认证逻辑无误。

* **编写文件**：
    * FlowBeat/backend/tests/conftest.py：定义 Pytest Fixtures (TestClient, Override Dependency)。
    * FlowBeat/backend/tests/api/test\_auth.py：编写登录成功/失败的测试用例。

## **第三阶段：前端基础与认证模块 (Frontend Foundation & Auth)**

**目标**：搭建 Vue 3 \+ TypeScript 前端架构，补全所有入口文件与通用逻辑，完成登录/注册流程闭环。

### **任务 3.1：前端工程化与入口配置**

配置 Vite、TypeScript 及 UI 库，建立 SPA 应用入口。

* **编写文件**：
    * FlowBeat/frontend/package.json：定义依赖与构建脚本。
    * FlowBeat/frontend/vite.config.ts：构建配置（路径别名 @, 代理配置）。
    * FlowBeat/frontend/tsconfig.json：TypeScript 严格模式配置。
    * FlowBeat/frontend/.env：配置 API Base URL。
    * FlowBeat/frontend/index.html：Vite 入口 HTML 文件。
    * FlowBeat/frontend/src/main.ts：Vue 应用挂载入口，引入全局样式。
    * FlowBeat/frontend/src/App.vue：根组件，承载 RouterView 和全局 Naive UI Provider。
    * FlowBeat/frontend/src/assets/：存放 Logo、默认头像等静态资源。

### **任务 3.2：网络层、API 封装与状态管理**

封装 Axios 拦截器与 Pinia 用户状态库，确保前后端接口映射完整。

* **编写文件**：
    * FlowBeat/frontend/src/api/axios.ts：统一处理 Token 注入与 401/403/500 错误拦截。
    * FlowBeat/frontend/src/types/api.ts：定义通用 API 响应泛型接口。
    * FlowBeat/frontend/src/types/entity.ts：定义 User 等核心实体类型。
    * FlowBeat/frontend/src/api/auth.ts：封装登录/注册 API。
    * FlowBeat/frontend/src/api/users.ts：封装用户详情查询、资料更新 API。
    * FlowBeat/frontend/src/api/index.ts：统一导出 API 模块，简化调用。
    * FlowBeat/frontend/src/stores/userStore.ts：管理 Token、用户信息与登录状态持久化。

### **任务 3.3：布局、通用组件与视图实现**

实现通用布局、主题切换及认证相关页面。

* **编写文件**：
    * FlowBeat/frontend/src/composables/useTheme.ts：封装深色/浅色模式切换逻辑。
    * FlowBeat/frontend/src/components/common/：创建 Loading.vue, ErrorMessage.vue 等复用组件。
    * FlowBeat/frontend/src/components/layout/：Header.vue (含用户下拉菜单), Sidebar.vue。
    * FlowBeat/frontend/src/router/index.ts：路由定义与 Auth Guard (NProgress 进度条集成)。
    * FlowBeat/frontend/src/views/auth/：Login.vue, Register.vue。
    * FlowBeat/frontend/src/views/profile/：UserProfile.vue (用户资料修改页)。

## **第四阶段：音乐资源管理子域 (Content & Metadata Subdomain)**

**目标**：实现管理员上传音乐的完整链路，确保 MinIO 文件存储与 PostgreSQL 元数据的一致性。

### **任务 4.1：音乐领域建模**

设计 Artist, Album, Music 实体及其关联关系。

* **编写文件**：
    * FlowBeat/backend/app/models/music.py：定义 Artist, Album, Music 实体及级联关系。
    * FlowBeat/backend/app/schemas/music.py：定义复杂的嵌套 Pydantic Schemas。
    * FlowBeat/backend/app/repositories/music\_repository.py：实现音乐元数据的增删改查及分页搜索。

### **任务 4.2：对象存储与业务服务**

封装 MinIO 客户端，实现上传业务逻辑与事务控制。

* **编写文件**：
    * FlowBeat/backend/app/services/minio\_client.py：MinIO 客户端封装 (PutObject, GetPresignedURL)。
    * FlowBeat/backend/app/services/music\_service.py：**关键**，处理文件上传与数据库写入的分布式事务编排及回滚逻辑。

### **任务 4.3：音乐管理接口与前端页面**

后端暴露上传/查询接口，前端实现库管理视图。

* **编写文件**：
    * FlowBeat/backend/app/api/v1/endpoints/music.py：上传音乐、创建专辑/艺术家接口。
    * FlowBeat/frontend/src/api/music.ts：前端 API 封装。
    * FlowBeat/frontend/src/views/library/：LibraryIndex.vue, UploadModal.vue (仅管理员可见)。

## **第五阶段：流媒体播放与交互子域 (Streaming & Interaction)**

**目标**：实现核心播放体验，并采集用户行为数据（隐式反馈）用于后续推荐。

### **任务 5.1：交互数据建模**

设计用于存储用户行为（播放、红心、跳过）的数据模型。

* **编写文件**：
    * FlowBeat/backend/app/models/interaction.py：定义 Interaction 实体 (含权重 weight 字段)。
    * FlowBeat/backend/app/repositories/interaction\_repository.py：高效写入交互日志。

### **任务 5.2：前端播放器核心逻辑**

封装 HTML5 Audio API，实现全局播放器状态管理。

* **编写文件**：
    * FlowBeat/frontend/src/composables/useAudio.ts：响应式音频控制 Hook (play, pause, seek, volume)。
    * FlowBeat/frontend/src/stores/playerStore.ts：全局播放状态 (Pinia)，管理当前播放队列。
    * FlowBeat/frontend/src/components/player/AudioPlayer.vue：底部固定播放条组件。
    * FlowBeat/frontend/src/components/player/PlayList.vue：侧边栏播放列表抽屉。

### **任务 5.3：交互事件上报**

在前端播放器事件中埋点，后端记录数据。

* **编写文件**：
    * FlowBeat/frontend/src/api/music.ts (增加 recordInteraction 方法)。
    * FlowBeat/backend/app/api/v1/endpoints/music.py (增加事件接收接口)。
    * FlowBeat/backend/app/services/music\_service.py (处理交互权重计算逻辑)。

## **第六阶段：推荐子域 (Recommendation Subdomain)**

**目标**：集成 Celery 与 Redis，实现离线协同过滤算法，并为用户生成个性化歌单。

### **任务 6.1：异步任务基础设施**

配置 Celery Worker 与 Redis 连接。

* **编写文件**：
    * FlowBeat/backend/app/workers/celery\_app.py：Celery 实例配置与任务发现。
    * FlowBeat/deploy/docker-compose.yml (确认 worker 服务配置与资源限制)。

### **任务 6.2：算法核心实现**

实现 Item-based CF 算法：数据加载 \-\> 矩阵计算 \-\> 相似度计算 \-\> 缓存结果。

* **编写文件**：
    * FlowBeat/backend/app/workers/tasks.py：**算法核心**，包含 NumPy/Pandas 数据预处理与 Cosine Similarity 计算逻辑。
    * FlowBeat/backend/app/services/recommendation\_service.py：推荐门面，负责读取 Redis 缓存或执行降级策略（如随机推荐）。

### **任务 6.3：推荐展示层**

后端暴露推荐接口，前端在“发现页”展示。

* **编写文件**：
    * FlowBeat/backend/app/api/v1/endpoints/recommendations.py：获取每日推荐接口。
    * FlowBeat/frontend/src/api/recommendation.ts：前端 API 封装。
    * FlowBeat/frontend/src/views/discovery/：Discovery.vue (展示推荐歌单), RecommendationCard.vue。

## **第七阶段：部署与交付 (Deployment & Delivery)**

**目标**：配置 Nginx 反向代理，优化 Docker 镜像，进行最终的系统集成测试。

### **任务 7.1：反向代理配置**

配置 Nginx 以转发 API 请求并托管前端静态资源。

* **编写文件**：
    * FlowBeat/deploy/nginx/nginx.conf：配置 /api 反向代理、Gzip 压缩与 Vue History 模式支持 (Try\_files)。

### **任务 7.2：最终编排与文档**

整合所有服务，验证一键启动功能，完善文档。

* **编写文件**：
    * FlowBeat/deploy/docker-compose.yml：最终检查，确保 env\_file 挂载正确且网络互通。
    * FlowBeat/README.md：更新部署步骤、环境变量说明与 API 文档截图。