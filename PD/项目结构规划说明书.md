# **FlowBeat 项目结构规划说明书 (Final Version)**

## **1\. 根目录结构 (Root Directory)**

根目录主要负责项目的整体编排与文档说明。为了确保前后端配置的严格隔离与安全性，环境变量配置文件已下沉至各子模块。

```text

FlowBeat/  
├── backend/                 # [Python] 后端应用代码 (FastAPI)  
├── frontend/                # [TypeScript] 前端应用代码 (Vue 3)  
├── deploy/                  # 部署相关配置  
│   ├── nginx/               # Nginx 反向代理配置  
│   │   └── nginx.conf  
│   └── docker-compose.yml   # 容器编排文件 (通过 env_file 指令分别加载前后端配置)  
├── .gitignore               # Git 忽略规则  
└── README.md                # 项目文档
```

## **2\. 后端目录结构 (Backend Architecture)**

后端采用 **分层架构 (Layered Architecture)**。此架构通过物理隔离确保了“关注点分离”，并利用环境变量文件管理敏感信息。

```text
backend/  
├── .env                                # [Git Ignored] 后端运行时配置 (DB链接, JWT密钥, MinIO密钥)  
├── app/  
│   ├── api/                            # [Interface Layer] 接口层  
│   │   ├── v1/                         # API 版本控制  
│   │   │   ├── endpoints/              # 具体路由定义  
│   │   │   │   ├── auth.py             # 认证相关接口 (Login, Register)  
│   │   │   │   ├── music.py            # 音乐资源管理接口  
│   │   │   │   ├── users.py            # 用户管理接口  
│   │   │   │   └── recommendations.py  # 推荐歌单接口 (仅负责数据获取)  
│   │   │   └── router.py               # 路由聚合  
│   │   └── deps.py                     # 依赖注入 (Dependency Injection) 定义  
│   │  
│   ├── core/                           # [Infrastructure] 核心配置  
│   │   ├── config.py                   # Pydantic Settings (类型安全的配置管理)  
│   │   ├── security.py                 # JWT Token 生成与解析逻辑  
│   │   └── exceptions.py               # 全局异常处理  
│   │  
│   ├── models/                         # [Domain Layer] 数据库实体 (SQLAlchemy Models)  
│   │   ├── __init__.py                 # 显式导出所有模型 (供 Alembic 识别)  
│   │   ├── base.py                     # Declarative Base 定义  
│   │   ├── user.py                     # User 实体  
│   │   ├── music.py                    # Artist, Album, Music 实体  
│   │   └── interaction.py              # UserInteraction 实体  
│   │  
│   ├── schemas/                        # [DTO] 数据传输对象 (Pydantic Models)  
│   │   ├── token.py                    # Token 响应结构  
│   │   ├── user.py                     # User Create/Response Schema  
│   │   └── music.py                    # Music, Artist, Album 的 Schema  
│   │  
│   ├── repositories/                   # [Repository Layer] 数据仓储模式  
│   │   ├── base.py                     # CRUD 通用基类 (泛型实现)  
│   │   ├── user_repository.py          # 用户特定查询 (如 get\_by\_email)  
│   │   ├── music_repository.py         # 音乐元数据访问  
│   │   └── interaction_repository.py   # 获取用于计算的原始交互数据  
│   │  
│   ├── services/                       # [Application Layer] 业务逻辑层  
│   │   ├── auth_service.py             # 认证业务 (密码哈希比对, Token 签发)  
│   │   ├── music_service.py            # 音乐上传事务编排 (MinIO + DB)  
│   │   ├── recommendation_service.py   # 推荐策略门面 (Redis 缓存读取/降级策略)  
│   │   └── minio_client.py             # MinIO 客户端封装  
│   │  
│   └── workers/                        # [Background Tasks] 离线计算与算法核心  
│       ├── celery_app.py               # Celery 实例配置  
│       └── tasks.py                    # [ALGORITHM CORE] 协同过滤算法实现  
│  
├── alembic/                            # 数据库迁移脚本目录  
├── tests/                              # 单元测试与集成测试  
├── main.py                             # FastAPI 应用入口  
├── pyproject.toml                      # 依赖管理 (Poetry/PDM)  
└── alembic.ini                         # Alembic 配置文件
```

### **后端关键文件详细说明**

* **app/core/config.py**:  
  * **设计模式**: 单例模式 (Singleton) / 配置对象模式。  
  * **功能**: 使用 pydantic-settings 库自动读取 .env 文件，并将环境变量映射为强类型的 Python 对象（如 settings.DATABASE\_URL）。这避免了在代码中到处使用 os.getenv()，提高了代码的健壮性。  
* **app/api/deps.py**:  
  * **设计模式**: 依赖注入 (Dependency Injection)。  
  * **功能**: 定义可复用的依赖项，例如 get\_db (获取数据库会话) 和 get\_current\_user (解析 Token 并获取当前用户对象)。FastAPI 将在处理请求前自动解析这些依赖，实现鉴权逻辑与业务逻辑的解耦。  
* **app/services/music\_service.py**:  
  * **功能**: 处理音乐上传的**分布式事务**一致性问题。  
  * **逻辑**:  
    1. 接收文件流，校验 MIME 类型。  
    2. 调用 minio\_client 将文件上传至对象存储，获取永久或预签名 URL。  
    3. 开启数据库事务，调用 music\_repository 将元数据（含 URL）写入 PostgreSQL。  
    4. 若任一步骤失败，执行回滚操作（如删除 MinIO 中的孤儿文件），保证数据一致性。  
* **app/workers/tasks.py**:  
  * **核心算法**: 基于物品的协同过滤 (Item-based Collaborative Filtering)。  
  * **逻辑**:  
    1. **数据加载**: 从数据库批量读取用户交互日志 (Interaction 表)。  
    2. **矩阵构建**: 使用 Surprise 或 Pandas 构建 User-Item 稀疏矩阵。  
    3. **相似度计算**: 计算物品间的余弦相似度 (Cosine Similarity)。  
    4. **推荐生成**: 为每个用户生成 Top-K 推荐列表。  
    5. **缓存预热**: 将计算结果序列化为 JSON，写入 Redis 的 recommendation:{user\_id} 键中，供在线服务毫秒级读取。  
* **app/models/\_\_init\_\_.py**:  
  * **工程细节**: 显式导入所有 Model 类 (from .user import User 等)。  
  * **目的**: 确保 Alembic 在生成迁移脚本时，能通过 Base.metadata 感知到所有已定义的表结构。若遗漏此步，迁移脚本将为空。

## **3\. 前端目录结构 (Frontend Architecture)**

前端基于 **Vue 3 Composition API** 和 **TypeScript**，强调**组件化**、**逻辑复用**与**类型安全**。

```text
frontend/  
├── .env                            # [Git Ignored] 前端构建配置 (API Base URL)    
├── src/  
│   ├── api/                        # [API Client] 后端接口请求封装  
│   │   ├── axios.ts                # [Infrastructure] Axios 实例 (拦截器配置)  
│   │   ├── auth.ts                 # 对应后端 auth.py  
│   │   ├── music.ts                # 对应后端 music.py (含 Artist, Album, Music)  
│   │   ├── users.ts                # 对应后端 users.py  
│   │   ├── recommendation.ts       # 对应后端 recommendations.py  
│   │   └── index.ts                # API 统一导出  
│   │  
│   ├── assets/                     # 静态资源 (Logo, 默认封面)  
│   │  
│   ├── components/                 # [UI Components] 通用组件  
│   │   ├── common/                 # 基础 UI (封装 Naive UI, Loading, Error)  
│   │   │   ├── Loading.vue         # 全局加载遮罩
│   │   │   ├── ErrorMessage.vue    # 错误提示横幅
│   │   │   └── LikeButton.vue      # 红心交互按钮 (复用于播放器和卡片)
│   │   ├── layout/                 # 布局组件 (Header, Sidebar)  
│   │   │   ├──MainLayout.vue       #  布局容器 (组合 Header + Sidebar)
│   │   │   ├──Header.vue           #  顶部导航 (主题切换/用户下拉)
│   │   │   └──Sidebar.vue          #  侧边菜单 (路由导航)
│   │   └── player/                 # 播放器业务组件  
│   │       ├── AudioPlayer.vue     # 底部播放控制条  
│   │       └── PlayList.vue        # 播放列表/队列抽屉  
│   │  
│   ├── composables/                # [Logic Reuse] 组合式函数 (Hooks)  
│   │   ├── useAudio.ts             # 核心：HTML5 Audio API 的响应式封装  
│   │   └── useTheme.ts             # 样式主题切换逻辑  
│   │  
│   ├── router/                     # [Routing] 路由配置  
│   │   └── index.ts                # 路由定义与全局守卫 (Auth Guard)  
│   │  
│   ├── stores/                     # [State Management] Pinia 状态管理  
│   │   ├── userStore.ts            # 用户会话状态 (Token, Role, Profile)  
│   │   ├── playlistStore.ts        # 歌单状态管理(用户歌单列表)
│   │   └── playerStore.ts          # 全局播放状态 (当前曲目, 播放列表, 播放模式)  
│   │  
│   ├── types/                      # [Type Definitions] TypeScript 类型契约  
│   │   ├── entity.ts               # 业务实体接口 (User, Music, Album)  
│   │   └── api.ts                  # API 请求/响应接口 (LoginReq, TokenRes)  
│   │  
│   ├── views/                      # [Pages] 页面级组件  
│   │   ├── auth/                   # 登录/注册页  
│   │   │   ├── Login.vue           #  登录页
│   │   │   └── Register.vue        #  注册页
│   │   ├── discovery/              # 发现页 (推荐列表展示)  
│   │   │   └── Discovery.vue       # 发现页
│   │   ├── library/                # 音乐库管理页  
│   │   │   ├── PlaylistDetail.vue  # 歌单详情页
│   │   │   ├── UploadModal.vue     # 上传音乐模态框
│   │   │   ├── FavoritesPage.vue   # 收藏列表页
│   │   │   └── LibraryIndex.vue    # 音乐库
│   │   └── profile/                # 用户个人中心  
│   │       └── UserProfile.vue     #  用户个人资料页
│   │  
│   ├── App.vue                     # 根组件  
│   └── main.ts                     # 入口文件 (挂载 Vue, Pinia, Router)  
│  
├── public/                         # 不经过构建的静态资源  
├── index.html                      # Vite 入口 HTML  
├── tsconfig.json                   # TypeScript 配置  
├──tsconfig.app.json                #  前端应用专用 TS 配置
├── vite.config.ts                  # Vite 构建配置  
└── package.json                    # 依赖管理
```

### **前端关键文件详细说明**

* **src/api/axios.ts**:  
  * **功能**: 统一的 HTTP 请求基础设施。  
  * **拦截器逻辑**:  
    * **请求拦截**: 从 localStorage 读取 token，若存在则自动添加到 Header Authorization: Bearer \<token\>。  
    * **响应拦截**: 统一捕获 401 Unauthorized 错误，强制重定向至登录页并清除过期状态；统一捕获网络异常并弹出全局提示。  
* **src/stores/playerStore.ts**:  
  * **设计模式**: 全局状态管理 (Global State Management)。  
  * **功能**: 管理跨组件的播放器状态。无论用户在哪个页面，底部的播放条都需要访问“当前播放歌曲”、“播放列表”、“是否暂停”等状态。使用 Pinia 实现响应式共享。  
* **src/composables/useAudio.ts**:  
  * **设计模式**: 组合式函数 (Composable) / 逻辑复用。  
  * **功能**: 封装原生的 HTML5 Audio 对象。  
  * **原因**: 播放器的逻辑（加载流、更新进度条、处理缓冲、音量控制）非常复杂且与 UI 无关。将其抽取为 Hook，可以保持 UI 组件 (AudioPlayer.vue) 的轻量化，并易于测试。  
* **src/types/entity.ts**:  
  * **功能**: 前端领域的类型定义。  
  * **重要性**: 此文件应与后端的 app/schemas 保持严格映射。例如，后端 MusicSchema 有 id, title, url 字段，前端接口 IMusic 也必须有相同定义。这保证了前后端联调时的类型安全，减少“undefined”错误。

## **4\. 基础设施与部署 (Infrastructure)**

```text
deploy/  
├── docker-compose.yml              # 定义所有服务  
└── nginx/  
    └── nginx.conf                  # 反向代理配置
```

### **部署关键配置说明**

* **deploy/docker-compose.yml**:  
  * **功能**: 一键编排整个微服务环境。  
  * **Env File 策略**: 使用 env\_file 指令分别加载 ../backend/.env 和 ../frontend/.env。这使得容器在启动时能自动注入正确的环境变量（如数据库连接串），无需在 YAML 文件中硬编码敏感信息。  
  * **服务编排**: 定义了 db (PostgreSQL), redis, minio, backend, worker (Celery), frontend (Nginx serving static files) 六个核心服务。  
* **deploy/nginx/nginx.conf**:  
  * **功能**: 作为流量入口和反向代理。  
  * **逻辑**:  
    * 匹配 /api/ 开头的请求 \-\> 转发给 backend:8000。  
    * 匹配 / (其他) 请求 \-\> 指向前端静态文件目录 (dist)，并配置 try\_files $uri $uri/ /index.html 以支持 Vue Router 的 History 模式（防止刷新 404）。